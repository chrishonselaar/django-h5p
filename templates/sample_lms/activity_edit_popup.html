{% extends 'base.html' %}

{% block title %}Edit H5P Activity - {{ activity.title }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'sample_lms:course_list' %}">Courses</a> &raquo;
    <a href="{% url 'sample_lms:course_detail' activity.course.id %}">{{ activity.course.title }}</a> &raquo;
    <a href="{% url 'sample_lms:activity_view' activity.id %}">{{ activity.title }}</a> &raquo;
    Edit
</div>

<div class="card">
    <h2>Edit H5P Content</h2>
    <p style="color: #666; margin-bottom: 15px;">
        Click the button below to open the H5P editor. When you save your changes, this page will update automatically.
    </p>

    <button id="open-editor-btn" class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;">
        Open H5P Editor
    </button>

    <div id="status" style="margin-top: 20px; padding: 15px; display: none;"></div>

    <div style="margin-top: 20px;">
        <a href="{% url 'sample_lms:activity_view' activity.id %}" class="btn btn-secondary">Cancel</a>
    </div>
</div>

<script>
(function() {
    const editorUrl = "{{ h5p_editor_url|safe }}";
    const activityViewUrl = "{% url 'sample_lms:activity_view' activity.id %}";
    let editorWindow = null;

    // Listen for localStorage changes (backup for cross-origin popup communication)
    window.addEventListener('storage', function(e) {
        if (e.key === 'h5p_content_saved') {
            try {
                const data = JSON.parse(e.newValue);
                if (data && Date.now() - data.timestamp < 5000) {
                    localStorage.removeItem('h5p_content_saved');
                    window.location.href = data.redirectUrl || activityViewUrl;
                }
            } catch (err) {}
        }
    });

    // Also check on focus (in case storage event was missed)
    window.addEventListener('focus', function() {
        try {
            const saved = localStorage.getItem('h5p_content_saved');
            if (saved) {
                const data = JSON.parse(saved);
                if (data && Date.now() - data.timestamp < 5000) {
                    localStorage.removeItem('h5p_content_saved');
                    window.location.href = data.redirectUrl || activityViewUrl;
                }
            }
        } catch (err) {}
    });

    document.getElementById('open-editor-btn').addEventListener('click', function() {
        // Open popup window
        const width = 1200;
        const height = 800;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;

        editorWindow = window.open(
            editorUrl,
            'h5p-editor',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );

        if (editorWindow) {
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').innerHTML =
                '<strong>Editor opened in popup.</strong><br>' +
                'Make your changes and click "Save Content" when done.<br>' +
                '<small style="color: #666;">This page will redirect automatically after saving.</small>';
            document.getElementById('status').style.background = '#e7f3ff';
            document.getElementById('status').style.border = '1px solid #b3d7ff';
            document.getElementById('status').style.borderRadius = '4px';

            // Check if popup was closed
            const checkPopup = setInterval(function() {
                if (editorWindow.closed) {
                    clearInterval(checkPopup);
                    // Give localStorage event a moment to fire, then redirect
                    setTimeout(function() {
                        window.location.href = activityViewUrl;
                    }, 300);
                }
            }, 500);
        } else {
            alert('Popup blocked! Please allow popups for this site.');
        }
    });
})();
</script>
{% endblock %}
